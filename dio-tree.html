<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ - Apache Superset Embed</title>
    <meta http-equiv="X-Frame-Options" content="allow-from *">
    <script>
        window.IFRAME_MODE = true;
    </script>
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' data: blob:;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: blob:;
    connect-src 'self' https://raw.githubusercontent.com https://api.github.com https://mark98molchanov-ally.github.io;
    font-src 'self';
">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    
    <style>
        /* –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ –∏–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã –≤ iframe */
        #githubLoadBtn, #jsonExportBtn, #jsonImportBtn, .watermark {
            display: none !important;
        }
        
        body {
            background: transparent !important; /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ */
            overflow: hidden; /* –°–∫—Ä–æ–ª–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –¥–µ—Ä–µ–≤–∞ */
        }

        .tree-container {
            height: 100vh !important;
            width: 100vw !important;
            padding: 20px !important;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ */
        .controls {
            top: 5px;
            left: 5px;
            transform: scale(0.9);
            transform-origin: top left;
        }
    </style>
    
    <script>
        const isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
        if (isChrome && parseInt(navigator.userAgent.match(/Chrome\/(\d+)/)?.[1] || 0) < 50) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏');
        }

        if (!window.Promise) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\/script>');
        }
        if (!window.fetch) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"><\/script>');
        }
    </script>
</head>

<body class="transition-colors duration-300">
    <div class="toggle-controls" id="toggleControls">‚â°</div>
    
    <div class="background-text" style="display: none;">
        <h1>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–æ–≥–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞</h1>
    </div>
    
    <div class="controls" id="controls">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." style="padding: 8px; border-radius: 8px; border: 1px solid var(--primary-color);">
        <span id="selectedCount" style="margin-left: 10px; font-size: 0.9em; color: var(--accent-color); display: none;">–í—ã–¥–µ–ª–µ–Ω–æ: 0</span>
        <div class="autocomplete-suggestions" id="searchSuggestions"></div>
        
        <button type="button" id="jsonExportBtn">JSON –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button type="button" id="jsonImportBtn">JSON –ò–º–ø–æ—Ä—Ç</button>
        
        <button type="button" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" id="collapseAllBtn">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button type="button" id="collapseParentBtn" class="collapse-parent-btn">–°–≤–µ—Ä–Ω—É—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è</button>
        
        <button type="button" id="addSuperordinateAboveBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—Ä—Ö—É</button>
        <button type="button" id="uploadFileBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        
        <button type="button" id="mark269Btn">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ 269-–ü</button>
        <button type="button" id="power269Btn">–ü–æ–ª–Ω–æ–º–æ—á–∏–µ –∏–∑ 269-–ü</button>
        <button type="button" id="subordinateBtn">–î–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã</button>
        <button type="button" id="forAllBtn">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
        <button type="button" id="authorityBtn">–ò–¥–µ–Ω—Ç–∏—á–Ω–æ–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–µ</button>
        <button type="button" id="okrBtn">OKR</button>
        <button type="button" id="indicatorBtn">–ì–æ—Å. –ø—Ä–æ–≥—Ä–∞–º–º–∞</button>
        <div class="cluster-controls" style="display: flex; gap: 5px; align-items: center;">
            <select id="clusterSelect" style="padding: 8px; border-radius: 8px; border: 1px solid var(--primary-color); background: var(--controls-bg); color: var(--text-color);">
                <option value="">–í—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</option>
            </select>
            <button id="addToClusterBtn" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Ç–µ—Ä">üè∑Ô∏è</button>
        </div>
        <button type="button" id="zoomInBtn">+</button>
        <button type="button" id="zoomResetBtn" class="reset-zoom-btn" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–± –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —É–∑–ª–µ">‚≠ï</button>
        <button type="button" id="zoomOutBtn">-</button>
        <div class="theme-switch" id="themeSwitch">
            <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
            <span class="theme-icon moon-icon">üåô</span>
            <div class="theme-switch-handle"></div>
            <div class="theme-transition-overlay" id="themeTransitionOverlay"></div>
        </div>
    </div>
    <div class="drop-zone" id="dropZone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
    <div id="tree" class="tree"></div>
    
    <div class="image-preview-container" id="previewContainer">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-preview" id="fullPreview">
    </div>
    <div class="watermark">Interactive Tree v9.2</div>
    <div class="history-log-icon" id="historyLogIcon" title="–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π">üïí</div>
    <div class="history-dialog-backdrop" id="historyDialogBackdrop">
        <div class="history-dialog">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
            <ul class="history-list" id="historyList"></ul>
            <button class="history-dialog-close" id="historyDialogClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    <div class="department-management" id="departmentManagement">
        <div class="department-header">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª–∞–º–∏</h2>
            <button id="closeDepartmentManagement">√ó –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="department-container" id="departmentContainer"></div>
    </div>
    <div id="tooltip-container" class="tooltip" style="display: none;"></div>
    
    <script src="node-effects.js"></script>
    <script src="indexed-db-manager.js"></script>
    <script src="tree-manager-core.js"></script>
    <script src="main.js"></script>
    
    <script>
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç index.html
        window.addEventListener('message', async function(event) {
            const message = event.data;
            
            // –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (message.type === 'GET_TREE_DATA') {
                console.log('DIO Tree: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö');
                if (window.treeManager) {
                    try {
                        const data = await window.treeManager.exportToJSON(); // –í main.js/tree-manager —ç—Ç–æ –æ–±—ã—á–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                        // –ù–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö, –∞ –Ω–µ —Å–∫–∞—á–∏–≤–∞—Ç—å —Ñ–∞–π–ª.
                        // –ï—Å–ª–∏ –º–µ—Ç–æ–¥ exportToJSON —Ç–æ–ª—å–∫–æ —Å–∫–∞—á–∏–≤–∞–µ—Ç, —Å–æ–∑–¥–∞–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–¥–µ—Å—å –≤—Ä—É—á–Ω—É—é
                        // –∏—Å–ø–æ–ª—å–∑—É—è –º–µ—Ç–æ–¥—ã treeManager
                        
                        const imagesToSave = {};
                        for(const [key, value] of Object.entries(window.treeManager.imagesData)) {
                           if(value.startsWith('data:image')) {
                              imagesToSave[key] = value;
                           }
                        }
                        
                        const exportData = {
                             version: '2.8',
                             tree: window.treeManager.serializeTree(window.treeManager.treeData),
                             images: imagesToSave,
                             filesData: window.treeManager.filesData,
                             clusters: Array.from(window.treeManager.clusters.entries()),
                             availableClusters: Array.from(window.treeManager.availableClusters),
                             settings: {
                               nodeCounter: window.treeManager.nodeCounter,
                               darkMode: window.treeManager.darkMode,
                               activeCluster: window.treeManager.activeCluster
                             },
                             timestamp: Date.now()
                        };
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ index.html
                        window.parent.postMessage({
                            type: 'TREE_DATA_RESPONSE',
                            payload: exportData
                        }, '*');
                        
                    } catch (e) {
                        console.error('DIO Tree: –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', e);
                    }
                }
            }
            
            // –ü—Ä–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
            if (message.type === 'IMPORT_TREE_DATA') {
                console.log('DIO Tree: –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                if (window.treeManager && message.payload) {
                    try {
                        await window.treeManager.importData(message.payload);
                        console.log('DIO Tree: –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω');
                    } catch (e) {
                        console.error('DIO Tree: –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', e);
                    }
                }
            }
        });
    </script>
</body>
</html>
