<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ - Apache Superset Embed</title>
    <meta http-equiv="X-Frame-Options" content="allow-from *">
    <script>
        // –°–æ–æ–±—â–∞–µ–º —Å–∫—Ä–∏–ø—Ç–∞–º, —á—Ç–æ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ iframe
        window.IFRAME_MODE = true;
    </script>
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' data: blob:;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: blob:;
    connect-src 'self' https://raw.githubusercontent.com https://api.github.com https://mark98molchanov-ally.github.io;
    font-src 'self';
">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    
    <style>
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ñ–ò–ú–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò --- */
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ –∏–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã –≤ iframe */
        #githubLoadBtn, 
        #jsonExportBtn, 
        #jsonImportBtn, 
        #saveBtn, /* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é */
        .watermark,
        .background-text,
        .toggle-controls {
            display: none !important;
        }
        
        /* –î–µ–ª–∞–µ–º —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º, —á—Ç–æ–±—ã —Å–ª–∏–≤–∞–ª—Å—è —Å –¥–∏–∑–∞–π–Ω–æ–º –≤–∫–ª–∞–¥–∫–∏ */
        body {
            background: transparent !important;
            overflow: hidden; /* –°–∫—Ä–æ–ª–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –¥–µ—Ä–µ–≤–∞ */
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ—Ä–µ–≤–∞ –¥–æ–ª–∂–µ–Ω –∑–∞–Ω–∏–º–∞—Ç—å –≤—Å—ë –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ iframe */
        .tree-container {
            height: 100vh !important;
            width: 100vw !important;
            padding: 20px !important;
            box-sizing: border-box;
            overflow: auto !important;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥ iframe */
        .controls {
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            max-width: none;
            box-sizing: border-box;
            justify-content: flex-start;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 5px;
            /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ */
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .controls::-webkit-scrollbar {
            display: none;
        }

        #githubLoadBtn {
            background: linear-gradient(145deg, #24292e, #0366d6) !important;
            color: white !important;
            border: none !important;
            padding: 8px 12px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            margin-left: 10px !important;
            font-weight: 500 !important;
        }
        
        #githubLoadBtn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(3, 102, 214, 0.3) !important;
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    
    <script>
        const isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
        if (isChrome && parseInt(navigator.userAgent.match(/Chrome\/(\d+)/)?.[1] || 0) < 50) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏');
        }

        if (!window.Promise) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\/script>');
        }
        if (!window.fetch) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"><\/script>');
        }
    </script>
</head>

<body class="transition-colors duration-300">
    <div class="toggle-controls" id="toggleControls">‚â°</div>
    
    <div class="background-text">
        <h1>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–æ–≥–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞</h1>
    </div>
    
    <div class="controls" id="controls">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." style="padding: 8px; border-radius: 8px; border: 1px solid var(--primary-color);">
        <span id="selectedCount" style="margin-left: 10px; font-size: 0.9em; color: var(--accent-color); display: none;">–í—ã–¥–µ–ª–µ–Ω–æ: 0</span>
        <div class="autocomplete-suggestions" id="searchSuggestions"></div>
        
        <button type="button" id="jsonExportBtn">JSON –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button type="button" id="jsonImportBtn">JSON –ò–º–ø–æ—Ä—Ç</button>
        <button type="button" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" id="collapseAllBtn">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button type="button" id="collapseParentBtn" class="collapse-parent-btn">–°–≤–µ—Ä–Ω—É—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è</button>
        
        <button type="button" id="addSuperordinateAboveBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—Ä—Ö—É</button>
        <button type="button" id="uploadFileBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        
        <button type="button" id="mark269Btn">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ 269-–ü</button>
        <button type="button" id="power269Btn">–ü–æ–ª–Ω–æ–º–æ—á–∏–µ –∏–∑ 269-–ü</button>
        <button type="button" id="subordinateBtn">–î–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã</button>
        <button type="button" id="forAllBtn">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
        <button type="button" id="authorityBtn">–ò–¥–µ–Ω—Ç–∏—á–Ω–æ–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–µ</button>
        <button type="button" id="okrBtn">OKR</button>
        <button type="button" id="indicatorBtn">–ì–æ—Å. –ø—Ä–æ–≥—Ä–∞–º–º–∞</button>
        <div class="cluster-controls" style="display: flex; gap: 5px; align-items: center;">
            <select id="clusterSelect" style="padding: 8px; border-radius: 8px; border: 1px solid var(--primary-color); background: var(--controls-bg); color: var(--text-color);">
                <option value="">–í—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</option>
            </select>
            <button id="addToClusterBtn" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Ç–µ—Ä">üè∑Ô∏è</button>
        </div>
        <button type="button" id="zoomInBtn">+</button>
        <button type="button" id="zoomResetBtn" class="reset-zoom-btn" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–± –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —É–∑–ª–µ">‚≠ï</button>
        <button type="button" id="zoomOutBtn">-</button>
        <div class="theme-switch" id="themeSwitch">
            <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
            <span class="theme-icon moon-icon">üåô</span>
            <div class="theme-switch-handle"></div>
            <div class="theme-transition-overlay" id="themeTransitionOverlay"></div>
        </div>
    </div>
    <div class="drop-zone" id="dropZone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
    <div id="tree" class="tree"></div>
    
    <div class="image-preview-container" id="previewContainer">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-preview" id="fullPreview">
    </div>
    <div class="watermark">Interactive Tree v9.2</div>
    <div class="history-log-icon" id="historyLogIcon" title="–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π">üïí</div>
    <div class="history-dialog-backdrop" id="historyDialogBackdrop">
        <div class="history-dialog">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
            <ul class="history-list" id="historyList"></ul>
            <button class="history-dialog-close" id="historyDialogClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    <div class="department-management" id="departmentManagement">
        <div class="department-header">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª–∞–º–∏</h2>
            <button id="closeDepartmentManagement">√ó –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="department-container" id="departmentContainer"></div>
    </div>
    <div id="tooltip-container" class="tooltip" style="display: none;"></div>
    
    <script src="node-effects.js"></script>
    <script src="indexed-db-manager.js"></script>
    <script src="tree-manager-core.js"></script>
    
    <script>
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É tree-manager-core.js
    console.log('=== –ü–†–û–í–ï–†–ö–ê –ó–ê–ì–†–£–ó–ö–ò –°–ö–†–ò–ü–¢–û–í ===');
    console.log('TreeManager –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof TreeManager !== 'undefined');
    console.log('TreeManagerCore –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof TreeManagerCore !== 'undefined');
    console.log('TreeManager –≤ window:', window.TreeManager);
    console.log('TreeManagerCore –≤ window:', window.TreeManagerCore);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ TreeManager - —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è
    if (typeof TreeManager === 'function') {
        console.log('‚úÖ TreeManager –∑–∞–≥—Ä—É–∂–µ–Ω –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è');
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
        window.treeManager = new TreeManager();
        console.log('‚úÖ treeManager —Å–æ–∑–¥–∞–Ω:', window.treeManager);
    } else if (typeof window.TreeManager === 'function') {
        console.log('‚úÖ window.TreeManager –∑–∞–≥—Ä—É–∂–µ–Ω');
        window.treeManager = new window.TreeManager();
        console.log('‚úÖ treeManager —Å–æ–∑–¥–∞–Ω –∏–∑ window.TreeManager');
    } else if (typeof TreeManagerCore === 'function') {
        console.log('‚úÖ TreeManagerCore –∑–∞–≥—Ä—É–∂–µ–Ω');
        window.treeManager = new TreeManagerCore();
        console.log('‚úÖ treeManager —Å–æ–∑–¥–∞–Ω –∏–∑ TreeManagerCore');
    } else {
        console.error('‚ùå TreeManager –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        window.treeManager = {
            initialize: () => console.log('TreeManager –∑–∞–≥–ª—É—à–∫–∞: initialize'),
            updateTree: () => console.log('TreeManager –∑–∞–≥–ª—É—à–∫–∞: updateTree'),
            saveData: () => console.log('TreeManager –∑–∞–≥–ª—É—à–∫–∞: saveData')
        };
    }
    </script>
    
    <script src="main.js"></script>
    
    <script>
    (function() {
        console.log('üîå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ—Å—Ç–∞ Iframe...');
        
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞ (index.html)
        window.addEventListener('message', async function(event) {
            const message = event.data;
            
            // 1. –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ GitHub
            if (message.type === 'GET_TREE_DATA') {
                console.log('üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å GET_TREE_DATA');
                if (window.treeManager) {
                    try {
                        // –°–æ–±–∏—Ä–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                        const tm = window.treeManager;
                        
                        // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const imagesToSave = {};
                        for(const [key, value] of Object.entries(tm.imagesData || {})) {
                           if(typeof value === 'string' && value.startsWith('data:image')) {
                              imagesToSave[key] = value;
                           }
                        }
                        
                        const exportData = {
                             version: '2.8',
                             tree: tm.serializeTree(tm.treeData),
                             images: imagesToSave,
                             filesData: tm.filesData || {},
                             clusters: Array.from(tm.clusters ? tm.clusters.entries() : []),
                             availableClusters: Array.from(tm.availableClusters || []),
                             settings: {
                               nodeCounter: tm.nodeCounter,
                               darkMode: tm.darkMode,
                               activeCluster: tm.activeCluster,
                               uiSettings: tm.uiSettings
                             },
                             timestamp: Date.now()
                        };
                        
                        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–¥–∏—Ç–µ–ª—é...');
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ index.html
                        window.parent.postMessage({
                            type: 'TREE_DATA_RESPONSE',
                            payload: exportData
                        }, '*');
                        
                    } catch (e) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ä–µ–≤–∞:', e);
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –Ω–µ –≤–µ—à–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è
                        window.parent.postMessage({ type: 'TREE_DATA_RESPONSE', payload: null }, '*');
                    }
                } else {
                    console.warn('‚ö† TreeManager –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤');
                    window.parent.postMessage({ type: 'TREE_DATA_RESPONSE', payload: null }, '*');
                }
            }
            
            // 2. –ü—Ä–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ (–∏–∑ GitHub –∏–ª–∏ JSON)
            if (message.type === 'IMPORT_TREE_DATA') {
                console.log('üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ (IMPORT_TREE_DATA)');
                if (window.treeManager && message.payload) {
                    try {
                        await window.treeManager.importData(message.payload);
                        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –¥–µ—Ä–µ–≤–æ');
                    } catch (e) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ –¥–µ—Ä–µ–≤–æ:', e);
                    }
                }
            }
        });
        
        // –°–æ–æ–±—â–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—é, —á—Ç–æ –º—ã –≥–æ—Ç–æ–≤—ã
        if (window.parent) {
            window.parent.postMessage({ type: 'TREE_READY' }, '*');
        }
    })();
    </script>

    <script>
        console.log('–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ tree-manager-core.js:');
        console.log('window.TreeManager:', window.TreeManager);
        console.log('window.TreeManagerCore:', window.TreeManagerCore);
        console.log('–í—Å–µ –∫–ª—é—á–∏ —Å Tree:', Object.keys(window).filter(k => k.includes('Tree')));
    </script>
</body>
</html>
